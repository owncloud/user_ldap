---
kind: pipeline
type: docker
name: coding-standard-php7.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: coding-standard
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: stop-recent-builds

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: stop-recent-builds
  pull: always
  image: drone/cli:alpine
  commands:
  - drone build ls  --status running > /var/www/owncloud/server/apps//recentBuilds.txt
  - drone build info  ${DRONE_BUILD_NUMBER} > /var/www/owncloud/server/apps//thisBuildInfo.txt
  - cd /var/www/owncloud/server/apps/ && ./.drone/cancelBuilds.sh
  environment:
    DRONE_SERVER: https://drone.owncloud.com
    DRONE_TOKEN:
      from_secret: drone_token
  when:
    event:
    - pull_request

trigger:
  ref:
  - refs/heads/master
  - refs/tags/**
  - refs/pull/**

---
kind: pipeline
type: docker
name: phpstan-php7.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: phpstan
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-phpstan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phan-php7.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: phan
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: check-starlark

platform:
  os: linux
  arch: amd64

steps:
- name: format-check-starlark
  pull: always
  image: owncloudci/bazel-buildifier
  commands:
  - buildifier --mode=check .drone.star

- name: show-diff
  pull: always
  image: owncloudci/bazel-buildifier
  commands:
  - buildifier --mode=fix .drone.star
  - git diff
  when:
    status:
    - failure

trigger:
  ref:
  - refs/pull/**

---
kind: pipeline
type: docker
name: IntegrationBackupServer

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationBackupServer.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationConnect

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationConnect.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestAccessGroupsMatchFilter

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestAccessGroupsMatchFilter.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestBackupServer

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestBackupServer.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestBatchApplyUserAttributes

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestBatchApplyUserAttributes.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestConnect

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestConnect.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestCountUsersByLoginName

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestCountUsersByLoginName.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestFetchUsersByLoginName

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestFetchUsersByLoginName.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: IntegrationTestPaging

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/IntegrationTestPaging.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: User/IntegrationTestUserAvatar

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/User/IntegrationTestUserAvatar.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: User/IntegrationTestUserDisplayName

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: setup-server-
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: ldap-integration-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - wait-for-it -t 600 ldap:636
  - php -f ./tests/integration/Lib/User/IntegrationTestUserDisplayName.php
  environment:
    LDAP_HOST: ldap

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: apiCopyFromPublicLink-master-mysql8.0-php7.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/ /var/www/owncloud/server/apps/

- name: setup-server-
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:20.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.3
  commands:
  - wait-for-it -t 600 ldap:636
  - cd /var/www/owncloud/server
  - bash ./apps/user_ldap/tests/acceptance/setConfig.sh
  - php occ ldap:set-config LDAPTestId ldapPort "636"
  - php occ ldap:set-config LDAPTestId ldapHost "ldaps://ldap"
  - php occ ldap:show-config
  - php occ ldap:test-config "LDAPTestId"
  - php occ user:sync "OCA\\User_LDAP\\User_Proxy" -m remove
  - php occ user:list

- name: wait-for-server
  pull: always
  image: owncloudci/wait-for:latest
  commands:
  - wait-for -it server:80 -t 600

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.3
  commands:
  - chown -R www-data /var/www/owncloud/server
  volumes:
  - name: downloads
    path: /home/seluser/Downloads/

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiCopyFromPublicLink
    DOWNLOADS_DIRECTORY: /var/www/owncloud/server/downloads
    TEST_SERVER_URL: http://server
    TEST_WITH_LDAP: true
  volumes:
  - name: downloads
    path: /var/www/owncloud/server/downloads

- name: build-github-comment-buildStop
  pull: always
  image: owncloud/ubuntu:20.04
  commands:
  - "echo ':boom: Acceptance tests pipeline <strong>apiCopyFromPublicLink-master-mysql8.0-php7.3</strong> failed. The build has been cancelled.\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}${DRONE_STAGE_NUMBER}/1\\n' >> /var/www/owncloud/comments.file"
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/comments.file
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  when:
    event:
    - pull_request
    status:
    - failure

- name: stop-build
  pull: always
  image: drone/cli:alpine
  commands:
  - drone build stop owncloud/ ${DRONE_BUILD_NUMBER}
  environment:
    DRONE_SERVER: https://drone.owncloud.com
    DRONE_TOKEN:
      from_secret: drone_token
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

- name: server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_LOGGING_PATH: /dev/null
    APACHE_WEBROOT: /var/www/owncloud/server

volumes:
- name: downloads
  temp: {}

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: apiCopyFromPublicLink-latest-mysql8.0-php7.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/ /var/www/owncloud/server/apps/

- name: setup-server-
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - "php occ a:e "
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - ""

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:20.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.3
  commands:
  - wait-for-it -t 600 ldap:636
  - cd /var/www/owncloud/server
  - bash ./apps/user_ldap/tests/acceptance/setConfig.sh
  - php occ ldap:set-config LDAPTestId ldapPort "636"
  - php occ ldap:set-config LDAPTestId ldapHost "ldaps://ldap"
  - php occ ldap:show-config
  - php occ ldap:test-config "LDAPTestId"
  - php occ user:sync "OCA\\User_LDAP\\User_Proxy" -m remove
  - php occ user:list

- name: wait-for-server
  pull: always
  image: owncloudci/wait-for:latest
  commands:
  - wait-for -it server:80 -t 600

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.3
  commands:
  - chown -R www-data /var/www/owncloud/server
  volumes:
  - name: downloads
    path: /home/seluser/Downloads/

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiCopyFromPublicLink
    DOWNLOADS_DIRECTORY: /var/www/owncloud/server/downloads
    TEST_SERVER_URL: http://server
    TEST_WITH_LDAP: true
  volumes:
  - name: downloads
    path: /var/www/owncloud/server/downloads

- name: build-github-comment-buildStop
  pull: always
  image: owncloud/ubuntu:20.04
  commands:
  - "echo ':boom: Acceptance tests pipeline <strong>apiCopyFromPublicLink-latest-mysql8.0-php7.3</strong> failed. The build has been cancelled.\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}${DRONE_STAGE_NUMBER}/1\\n' >> /var/www/owncloud/comments.file"
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/comments.file
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  when:
    event:
    - pull_request
    status:
    - failure

- name: stop-build
  pull: always
  image: drone/cli:alpine
  commands:
  - drone build stop owncloud/ ${DRONE_BUILD_NUMBER}
  environment:
    DRONE_SERVER: https://drone.owncloud.com
    DRONE_TOKEN:
      from_secret: drone_token
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ldap
  pull: always
  image: osixia/openldap
  environment:
    LDAP_ADMIN_PASSWORD: admin
    LDAP_DOMAIN: owncloud.com
    LDAP_ORGANISATION: owncloud
    LDAP_TLS_VERIFY_CLIENT: never

- name: server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_LOGGING_PATH: /dev/null
    APACHE_WEBROOT: /var/www/owncloud/server

volumes:
- name: downloads
  temp: {}

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.4
- stop-recent-builds
- phpstan-php7.4
- phan-php7.4
- check-starlark

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
    webhook:
      from_secret: private_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  status:
  - success
  - failure

depends_on:
- IntegrationBackupServer
- IntegrationConnect
- IntegrationTestAccessGroupsMatchFilter
- IntegrationTestBackupServer
- IntegrationTestBatchApplyUserAttributes
- IntegrationTestConnect
- IntegrationTestCountUsersByLoginName
- IntegrationTestFetchUsersByLoginName
- IntegrationTestPaging
- User/IntegrationTestUserAvatar
- User/IntegrationTestUserDisplayName
- apiCopyFromPublicLink-master-mysql8.0-php7.3
- apiCopyFromPublicLink-latest-mysql8.0-php7.3

...
